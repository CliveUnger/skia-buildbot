<!--
  The <results-page-sk> custom element declaration.

  Shows the results of render and sort requests. JSON requests to the render
  endpoint ('/json/render') will incrementally display data on the page; these
  requests are sent using scroll actions on the page.

  Clicking on a sort parameter in the dropdown will send a request to the sort
  endpoint ('/json/sort'), which sorts the list of results on the backend using
  the specified parameters, resets the data being displayed, and sends a render
  request to display the new data.

  Attributes:
    data - A list of serialized ResultRec instances, used as the container for
           render requests. Reset on sort requests.
    renderIdx - An index to keep track which range in the server cache the page
                should render next. Reset on sort requests.
    chunkSize - The number of results that a render request retrieves and
                displays.

  Events:
    None

  Methods:
    None
-->

<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="activity-sk.html">
<link rel="import" href="diff-details-sk.html">
<link rel="import" href="shared-styles.html">

<dom-module id="results-page-sk">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style include="shared-styles">
      diff-details-sk {
        display: inline-block;
        box-shadow: 3px 3px 6px 1px rgba(133,133,133,1);
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 0;
        padding-left: 1em;
        padding-top: 1em;
        padding-bottom: 1em;
        padding-right: 0;
      }

      diff-details-sk[data-focus] {
        box-shadow: 3px 3px 6px 5px #FF7F00;
      }

      paper-dropdown-menu {
        padding-left: 1em;
        width: 320px;
      }

      paper-listbox {
        width: 325px;
      }

      .loader {
        background-color: #0b8043;
        text-align: center;
        height: 44px;
        line-height: 44px;
        color: white;
      }
    </style>
    <activity-sk id="activityBar" busy="{{_hideAll}}"></activity-sk>
    <div hidden$="{{_hideAll}}">
      <paper-dropdown-menu id="sortmenu" label="Sort By">
        <paper-listbox class="dropdown-content" selected="5">
          <paper-item value="numDiff">Number of Different Pixels</paper-item>
          <paper-item value="percentDiff">Percentage of Different Pixels</paper-item>
          <paper-item value="redDiff">Max Red Difference</paper-item>
          <paper-item value="greenDiff">Max Green Difference</paper-item>
          <paper-item value="blueDiff">Max Blue Difference</paper-item>
          <paper-item value="rank">Site Popularity</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-dropdown-menu id="ordermenu" label="Sort Order">
        <paper-listbox class="dropdown-content" selected="1">
          <paper-item value="ascending">Ascending</paper-item>
          <paper-item value="descending">Descending</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>
      <iron-scroll-threshold id="scroller" on-lower-threshold="_renderMoreData" scroll-target="document">
        <template is="dom-repeat" items="[[data]]">
          <diff-details-sk
            url="[[item.URL]]"
            rank="[[item.Rank]]"
            left="[[item.NoPatchImg]]"
            right="[[item.WithPatchImg]]"
            diffmetrics="[[item.DiffMetrics]]">
          </diff-details-sk>
        </template>
        <div class="loader">Fetching more items...</div>
      </iron-scroll-threshold>
    </div>
  </template>
  <script>
    Polymer({
      is: "results-page-sk",

      properties: {
        data: {
          type: Array,
          value: function() { return []; }
        },

        renderIdx: {
          type: Number
        },

        chunkSize: {
          type: Number,
          value: 20,
        },
      },

      listeners: {
        'iron-select': '_sortSelect'
      },

      _renderMoreData: function() {
        // Avoid rendering data before the default sort parameter has been
        // processed, as iron-scroll-threshold is triggered on page load.
        if (this.renderIdx === undefined) {
          return
        }
        var runID = window.location.search;
        var startIdx = 'startIdx=' + this.renderIdx;
        var endIdx = 'endIdx=' + (this.renderIdx + this.chunkSize);
        var query = runID + '&' + startIdx + '&' + endIdx;
        sk.get("/json/render" + query).then(JSON.parse).then(function (json) {
          console.log("render request)")
          for (var i = 0; i < json.results.length; i++) {
            this.data.push(json.results[i]);
          }
          this.notifyPath('data', this.data.slice());
          this.renderIdx = json.index
          this.$.activityBar.stopSpinner();
          this.$.scroller.clearTriggers();
        }.bind(this)).catch(function(e) {
          this.$.activityBar.stopSpinner();
          sk.errorMessage(e);
        }.bind(this));
      },

      _sortSelect: function() {
        var runID = window.location.search;
        var sortField = 'sortField=' + this.$.sortmenu.selectedItem.getAttribute('value');
        var sortOrder = 'sortOrder=' + this.$.ordermenu.selectedItem.getAttribute('value');
        var query = runID + '&' + sortField + '&' + sortOrder;
        sk.get("/json/sort" + query).then(function () {
          this.data = [];
          this.renderIdx = 0;
          this._renderMoreData()
        }.bind(this)).catch(function(e) {
          this.$.activityBar.stopSpinner();
          sk.errorMessage(e);
        }.bind(this));
      },
    });
  </script>
</dom-module>
